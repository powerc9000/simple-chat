<!doctype html>
<html>
	<head>
		<title>Chat!</title>
		<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
		<link rel="stylesheet" href="/css/style.css">
		<script src="/socket.io/socket.io.js"></script>

	</head>
	<body>
		<div class="container">
			<div class="chatArea row" style="display:none">
				<div class="span8">
					<h3>Messages</h3>
					<div class="messages" id="messagebox">
					</div>
					<form  id="messageform" class="well row">
						<input type="text" name="message" class="span8">
						<input type="submit" value="Send Message" class="btn btn-primary pull-right">
					</form>
				</div>
				<div class="span4">
					<h1>People online</h1>
					<ul class="online unstyled"></ul>
				</div>
			</div>
			<div class="username">
				<h1>First we need a username</h1>
				<form id="username">
					<input type="text" name="username" >
					<input type="submit" value="Set Username" class="btn btn-primary">
				</form>
			</div>
		</div>
		
		
		<script>
			(function(){
				var socket = io.connect();
				var form = document.getElementById("messageform");
				var usernameForm = document.getElementById("username");
				var focused = true;
				var missMessage = 0;
				var alert = new Audio();
				alert.src = "/sound/alert.mp3";
				usernameForm.addEventListener("submit", setUsername, false);
				form.addEventListener("submit", sendMessage, false);
				window.addEventListener("focus", onfocus);
				window.addEventListener("blur", onblur);

				socket.on("message", handleMessage);
				socket.on("online", usersOnline);
				function handleMessage(username, message){
					var box = document.getElementById("messagebox"),
						messagearea = createElement("<p class='message'></p>"),
						title;
					if(!focused){
						missMessage++;
						title = window.document.title;
						window.document.title = "("+missMessage+") Chat!";
						alert.pause();
						alert.currentTime = 0;
						alert.play();
					}
					if(message){
						messagearea.textContent = username + ": " + message;
					}
					else{
						messagearea.textContent = username;
						messagearea.classList.add('system-message');

					}
					
					messagearea.style.visibility = "hidden";
					messagearea = box.appendChild(messagearea);
					setTimeout(function(){
						scrollbot();
						messagearea.style.visibility = "visible";
					}, 0)
				}

				function sendMessage(e){
					var message = form.message.value;
					socket.emit("message", message);
					form.message.value = "";
					e.preventDefault();
				}

				function setUsername(e){
					var chat = document.getElementsByClassName("chatArea")[0];
					var formContain = document.getElementsByClassName("username")[0];
					chat.style.display = "block";
					formContain.style.display = "none";
					socket.emit("username", usernameForm.username.value);
					e.preventDefault();
				}

				function createElement(text){
					var holder = document.createElement("div"),
					frag = document.createDocumentFragment();
					holder.innerHTML = text;
					while(holder.firstChild){
						frag.appendChild(holder.firstChild);
					}
					return frag.firstChild;
				}

				function scrollbot(){
					var d = document.getElementById('messagebox');

					if(d.scrollHeight > d.clientHeight) {
					  d.scrollTop = d.scrollHeight - d.clientHeight;
					}
				}

				function usersOnline(users){
					console.log(users)
					var list = document.getElementsByClassName("online")[0];
					list.innerHTML = "";
					users.forEach(function(u){
						var item = createElement("<li>"+u+"</li>");
						list.appendChild(item);
					});
				}

				function onfocus(){
					focused = true;
					window.document.title = "Chat!"
					missMessage = 0;
				}

				function onblur(){
					focused = false;
				}
			}())
			
		</script>
	</body>
</html>